name: è‡ªåŠ¨æ„å»ºå¼€å‘ç‰ˆæœ¬

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

# é™åˆ¶å¹¶å‘æ‰§è¡Œ
concurrency:
  group: dev-build-${{ github.ref }}
  cancel-in-progress: true

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  actions: read

env:
  VITE_BUILD_TYPE: development

jobs:
  build-windows:
    name: æ„å»ºWindowsç‰ˆæœ¬
    runs-on: windows-latest # ä½¿ç”¨GitHubæ‰˜ç®¡çš„WindowsæœåŠ¡å™¨
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.create_tag.outputs.tag_name }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          # å¼ºåˆ¶è·å–æœ€æ–°ä»£ç ï¼Œé¿å…ç¼“å­˜é—®é¢˜
          ref: ${{ github.ref }}

      - name: é…ç½®Gitå®‰å…¨ç›®å½•
        run: |
          git config --global --add safe.directory $env:GITHUB_WORKSPACE
          Write-Host "âœ… Git safe directory configured"
          
      - name: ç¡®ä¿è·å–æœ€æ–°ä»£ç 
        run: |
          git fetch origin ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}
          $currentCommit = git rev-parse HEAD
          Write-Host "ğŸ“ Current commit: $currentCommit"
          Write-Host "ğŸ“ Expected commit: ${{ github.sha }}"
          if ($currentCommit -ne "${{ github.sha }}") {
            Write-Error "âŒ Commit mismatch! Expected ${{ github.sha }}, got $currentCommit"
            exit 1
          }
          Write-Host "âœ… Code is up to date"

      - name: è·å–åŒ…ç‰ˆæœ¬å¹¶åˆ›å»ºå¼€å‘ç‰ˆæœ¬
        id: version
        run: |
          # è¯»å– package.json çš„ç‰ˆæœ¬å·
          $packageJson = Get-Content -Raw -Path "package.json" -Encoding UTF8 | ConvertFrom-Json
          $packageVersion = $packageJson.version
          
          # è·å–å½“å‰åŸºç¡€ç‰ˆæœ¬çš„æ‰€æœ‰å¼€å‘ç‰ˆæœ¬æ ‡ç­¾
          $allTags = git tag -l "dev-$packageVersion-dev.*" | Sort-Object -Descending
          
          # è®¡ç®—ä¸‹ä¸€ä¸ªæ„å»ºå·
          $buildNumber = 1
          if ($allTags.Count -gt 0) {
            # ä»æœ€æ–°çš„æ ‡ç­¾ä¸­æå–æ„å»ºå·
            $latestTag = $allTags[0]
            if ($latestTag -match "dev-$packageVersion-dev\.(\d+)$") {
              $buildNumber = [int]$matches[1] + 1
            }
          }
          
          $devVersion = "$packageVersion-dev.$buildNumber"
          
          echo "version=$devVersion" >> $env:GITHUB_OUTPUT
          echo "package_version=$packageVersion" >> $env:GITHUB_OUTPUT
          echo "build_number=$buildNumber" >> $env:GITHUB_OUTPUT
          
          Write-Host "ğŸ“¦ Package Version: $packageVersion"
          Write-Host "ğŸ”§ Dev Version: $devVersion"
          Write-Host "ğŸ”¢ Build Number: $buildNumber"

      - name: åˆ›å»ºå¼€å‘æ ‡ç­¾
        id: create_tag
        run: |
          $tagName = "dev-${{ steps.version.outputs.version }}"
          echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
          
          # æ£€æŸ¥tagæ˜¯å¦å·²å­˜åœ¨
          $existingTags = git ls-remote --tags origin
          if ($existingTags -match "refs/tags/$tagName`$") {
            Write-Host "âš ï¸ Tag $tagName already exists, skipping creation"
          } else {
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag -a "$tagName" -m "ğŸ”§ Auto Dev Build: ${{ steps.version.outputs.version }}"
            git push origin "$tagName"
            Write-Host "âœ… Created and pushed tag: $tagName"
          }

      # å…‹éš†åç«¯ä»“åº“ - ç¡®ä¿è·å–æœ€æ–°ä»£ç 
      - name: å…‹éš†åç«¯ä»“åº“
        run: |
          if (Test-Path "backend") { 
            Remove-Item -Recurse -Force "backend" 
            Write-Host "ğŸ—‘ï¸ Removed existing backend directory"
          }
          
          # å…‹éš†æœ€æ–°çš„ä¸»åˆ†æ”¯ä»£ç 
          git clone --depth=1 --branch=main https://github.com/MaiM-with-u/mailauncher-backend.git backend
          
          cd backend
          $backendCommit = git rev-parse HEAD
          Write-Host "ğŸ“ Backend commit: $backendCommit"
          Write-Host "âœ… Backend repository cloned successfully"

      # è®¾ç½® Python ç¯å¢ƒï¼ˆGitHubæ‰˜ç®¡çš„runnerï¼‰
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      # ç¼“å­˜ pip ä¾èµ– - ä½¿ç”¨æ›´å…·ä½“çš„ç¼“å­˜é”®
      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-dev-${{ hashFiles('backend/requirements.txt') }}-${{ github.run_number }}
          restore-keys: |
            ${{ runner.os }}-pip-dev-${{ hashFiles('backend/requirements.txt') }}
            ${{ runner.os }}-pip-

      # å®‰è£…åç«¯æ„å»ºä¾èµ–
      - name: å®‰è£…åç«¯ä¾èµ–
        run: |
          cd backend
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pyinstaller
          Write-Host "âœ… Backend dependencies installed"
          
      # åˆ›å»ºæ•°æ®ç›®å½•
      - name: åˆ›å»ºåç«¯æ•°æ®ç›®å½•
        run: |
          cd backend
          if (!(Test-Path "data")) { New-Item -ItemType Directory -Path "data" }
          
      # æ„å»º Windows åç«¯
      - name: æ„å»ºWindowsåç«¯
        run: |
          cd backend
          
          # æ¸…ç†ä¹‹å‰çš„æ„å»ºäº§ç‰©
          if (Test-Path "dist") { 
            Remove-Item -Recurse -Force "dist" 
            Write-Host "ğŸ—‘ï¸ Cleaned previous build artifacts"
          }
          if (Test-Path "build") { 
            Remove-Item -Recurse -Force "build" 
            Write-Host "ğŸ—‘ï¸ Cleaned previous build cache"
          }
          
          # æ˜¾ç¤ºå½“å‰ä»£ç ä¿¡æ¯
          $currentCommit = git rev-parse HEAD
          Write-Host "ğŸ“ Building backend from commit: $currentCommit"
          
          python -m PyInstaller main.spec --clean
          Write-Host "âœ… Backend build completed"
          
      # å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶åˆ° Tauri binaries ç›®å½•
      - name: å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶åˆ°Tauriç›®å½•
        run: |
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          if (!(Test-Path "src-tauri\binaries")) { 
            New-Item -ItemType Directory -Path "src-tauri\binaries" -Force 
            Write-Host "âœ… Created binaries directory"
          }
          
          # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          $sourceFile = "backend\dist\MaiLauncher-Backend.exe"
          $destFile = "src-tauri\binaries\MaiLauncher-Backend-x86_64-pc-windows-msvc.exe"
          
          if (Test-Path $sourceFile) {
            Copy-Item $sourceFile $destFile -Force
            Write-Host "âœ… Backend executable copied successfully: $sourceFile -> $destFile"
            
            # éªŒè¯æ–‡ä»¶å­˜åœ¨
            if (Test-Path $destFile) {
              $fileSize = (Get-Item $destFile).Length
              Write-Host "âœ… File verification successful, size: $([math]::round($fileSize/1MB, 2)) MB"
            } else {
              Write-Error "âŒ File copy failed"
              exit 1
            }
          } else {
            Write-Error "âŒ Source file does not exist: $sourceFile"
            Write-Host "Listing backend/dist directory contents:"
            if (Test-Path "backend\dist") {
              Get-ChildItem "backend\dist" -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
            } else {
              Write-Host "  Directory does not exist"
            }
            exit 1
          }

      # æ£€æŸ¥å¹¶å®‰è£… Node.js
      - name: è®¾ç½®Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          
      # è®¾ç½® pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest
          run_install: false

      # æ¸…ç†å‰ç«¯ç¼“å­˜
      - name: æ¸…ç†å‰ç«¯ç¼“å­˜
        run: |
          # æ¸…ç† pnpm ç¼“å­˜
          if (Get-Command pnpm -ErrorAction SilentlyContinue) {
            pnpm store prune
            Write-Host "ğŸ—‘ï¸ Cleaned pnpm store"
          }
          
          # æ¸…ç† node_modules
          if (Test-Path "node_modules") {
            Remove-Item -Recurse -Force "node_modules"
            Write-Host "ğŸ—‘ï¸ Removed node_modules"
          }
          
          # æ¸…ç†æ„å»ºç¼“å­˜
          if (Test-Path "dist") {
            Remove-Item -Recurse -Force "dist"
            Write-Host "ğŸ—‘ï¸ Removed dist directory"
          }
          
          Write-Host "âœ… Frontend cache cleaned"

      # å®‰è£…å‰ç«¯ä¾èµ–
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          Write-Host "ğŸ“¦ Installing fresh dependencies..."
          pnpm install --no-frozen-lockfile --force
          Write-Host "âœ… Dependencies installed"

      # ä¸´æ—¶æ›´æ–°ç‰ˆæœ¬å·ç”¨äºæ„å»º
      - name: ä¸´æ—¶æ›´æ–°ç‰ˆæœ¬å·ç”¨äºæ„å»º
        run: |
          $devVersion = "${{ steps.version.outputs.version }}"
          
          # ä¸´æ—¶æ›´æ–°package.jsonç‰ˆæœ¬å·ï¼ˆä»…ç”¨äºæ„å»ºï¼Œä¸æäº¤ï¼‰
          $packageJson = Get-Content -Raw -Path "package.json" -Encoding UTF8 | ConvertFrom-Json
          $originalVersion = $packageJson.version
          $packageJson.version = $devVersion
          $packageJson | ConvertTo-Json -Depth 100 | Set-Content -Path "package.json" -Encoding UTF8
          Write-Host "ğŸ”§ Temporarily updated package.json version: $originalVersion -> $devVersion"
          
          # ä¸´æ—¶æ›´æ–°Cargo.tomlç‰ˆæœ¬å·ï¼ˆä»…ç”¨äºæ„å»ºï¼Œä¸æäº¤ï¼‰
          $cargoToml = Get-Content -Path "src-tauri\Cargo.toml" -Encoding UTF8
          $cargoToml = $cargoToml -replace '^version = ".*"', "version = `"$devVersion`""
          $cargoToml | Set-Content -Path "src-tauri\Cargo.toml" -Encoding UTF8
          Write-Host "ğŸ”§ Temporarily updated Cargo.toml version to: $devVersion"

      # æ„å»º Tauri åº”ç”¨ï¼ˆDevç‰ˆæœ¬ï¼‰
      - name: æ„å»ºTauriåº”ç”¨ï¼ˆå¼€å‘ç‰ˆæœ¬ï¼‰
        run: |
          Write-Host "ğŸ”§ Building Dev Version: ${{ steps.version.outputs.version }}"
          
          # æ¸…ç† Tauri æ„å»ºç¼“å­˜
          if (Test-Path "src-tauri\target") {
            Remove-Item -Recurse -Force "src-tauri\target"
            Write-Host "ğŸ—‘ï¸ Cleaned Tauri build cache"
          }
          
          # æ˜¾ç¤ºæ„å»ºä¿¡æ¯
          Write-Host "ğŸ“ Frontend commit: ${{ github.sha }}"
          
          # æ„å»ºå‰ç«¯
          pnpm run build:dev
          
          # æ„å»º Tauri åº”ç”¨
          pnpm tauri build
          
          Write-Host "âœ… Tauri build completed"
          
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ å¼€å‘ç‰ˆæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dev-build-windows-${{ steps.version.outputs.version }}
          path: src-tauri/target/release/bundle/
          retention-days: 7

      - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
        run: |
          # è·å–åç«¯æäº¤ä¿¡æ¯
          cd backend
          $backendCommit = git rev-parse HEAD
          $backendCommitShort = git rev-parse --short HEAD
          cd ..
          
          # æ„å»ºå‘å¸ƒè¯´æ˜å†…å®¹
          $releaseNote = "# ğŸ”§ å¼€å‘ç‰ˆæœ¬æ„å»º - ${{ steps.version.outputs.version }}`n`n"
          $releaseNote += "## ğŸ“‹ æ„å»ºä¿¡æ¯`n"
          $releaseNote += "- **åŸºç¡€ç‰ˆæœ¬**: ${{ steps.version.outputs.package_version }}`n"
          $releaseNote += "- **æ„å»ºæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')`n"
          $releaseNote += "- **æ„å»ºç±»å‹**: Development`n"
          $releaseNote += "- **å‰ç«¯æäº¤**: ${{ github.sha }}`n"
          $releaseNote += "- **åç«¯æäº¤**: $backendCommit`n"
          $releaseNote += "- **åˆ†æ”¯**: ${{ github.ref_name }}`n"
          $releaseNote += "- **æ„å»ºå·**: ${{ github.run_number }}`n`n"
          $releaseNote += "## ğŸ” ä»£ç ç‰ˆæœ¬è¯¦æƒ…`n"
          $releaseNote += "- **å‰ç«¯ä»“åº“**: [mailauncher@${{ github.sha }}](https://github.com/MaiM-with-u/mailauncher/commit/${{ github.sha }})`n"
          $releaseNote += "- **åç«¯ä»“åº“**: [mailauncher-backend@$backendCommitShort](https://github.com/MaiM-with-u/mailauncher-backend/commit/$backendCommit)`n`n"
          $releaseNote += "## âš ï¸ æ³¨æ„äº‹é¡¹`n"
          $releaseNote += "è¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„å¼€å‘ç‰ˆæœ¬ï¼Œä»…ç”¨äºæµ‹è¯•å’Œå¼€å‘ç›®çš„ã€‚`n"
          $releaseNote += "- å¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„åŠŸèƒ½`n"
          $releaseNote += "- ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨`n"
          $releaseNote += "- è¯¥ç‰ˆæœ¬ä¼šå®šæœŸæ¸…ç†`n"
          $releaseNote += "- æœ¬æ¬¡æ„å»ºç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç ï¼Œæ¸…ç†äº†æ‰€æœ‰ç¼“å­˜`n`n"
          $releaseNote += "## ğŸ“¦ ä¸‹è½½`n"
          $releaseNote += "- Windows: MSI, EXE å®‰è£…åŒ…`n`n"
          $releaseNote += "---`n"
          $releaseNote += "*æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*"
          
          $releaseNote | Set-Content -Path "release_note.md" -Encoding UTF8
          Write-Host "âœ… Release notes created"

      - name: åˆ›å»ºå¼€å‘ç‰ˆå‘å¸ƒ
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_tag.outputs.tag_name }}
          name: "ğŸ”§ Dev Build - ${{ steps.version.outputs.version }}"
          body_path: release_note.md
          files: |
            src-tauri/target/release/bundle/**/*.msi
            src-tauri/target/release/bundle/**/*.exe
          prerelease: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-old-dev-releases:
    name: æ¸…ç†æ—§å¼€å‘ç‰ˆæœ¬
    needs: [build-windows]
    runs-on: windows-latest # ä½¿ç”¨GitHubæ‰˜ç®¡çš„WindowsæœåŠ¡å™¨
    if: always()
    
    steps:
      - name: æ¸…ç†æ—§çš„å¼€å‘ç‰ˆå‘å¸ƒ
        run: |
          Write-Host "ğŸ§¹ Cleaning up old dev releases..."
          
          # è·å–æ‰€æœ‰å¼€å‘ç‰ˆæœ¬çš„releasesï¼ˆæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼‰
          $releases = gh release list --limit 50 --json tagName,createdAt,prerelease,id | ConvertFrom-Json
          $devReleases = $releases | Where-Object { $_.prerelease -eq $true -and $_.tagName -match "^dev-" } | Sort-Object createdAt -Descending
          
          Write-Host "Found $($devReleases.Count) dev releases"
          
          # ä¿ç•™æœ€æ–°çš„5ä¸ªå¼€å‘ç‰ˆæœ¬ï¼Œåˆ é™¤å…¶ä½™çš„
          if ($devReleases.Count -gt 5) {
            $releasesToDelete = $devReleases | Select-Object -Skip 5
            
            foreach ($release in $releasesToDelete) {
              $tagName = $release.tagName
              Write-Host "ğŸ—‘ï¸ Deleting old dev release: $tagName"
              
              try {
                # åˆ é™¤release
                gh release delete $tagName --yes
                
                # åˆ é™¤tag
                git push --delete origin $tagName
                
                Write-Host "âœ… Deleted: $tagName"
              } catch {
                Write-Host "âŒ Failed to delete: $tagName - $($_.Exception.Message)"
              }
            }
          } else {
            Write-Host "âœ… No cleanup needed (less than 5 dev releases)"
          }
          
          Write-Host "âœ… Cleanup completed. Kept $([Math]::Min(5, $($devReleases.Count))) dev releases."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
