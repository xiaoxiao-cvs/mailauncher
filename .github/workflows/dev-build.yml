name: è‡ªåŠ¨æ„å»ºå¼€å‘ç‰ˆæœ¬

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

# é™åˆ¶å¹¶å‘æ‰§è¡Œ
concurrency:
  group: dev-build-${{ github.ref }}
  cancel-in-progress: true

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  actions: read

env:
  VITE_BUILD_TYPE: development

jobs:
  build-windows:
    name: æ„å»ºWindowsç‰ˆæœ¬
    runs-on: [self-hosted, windows, x64] # ä»…ä½¿ç”¨è‡ªæ‰˜ç®¡çš„ Windows runner
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.create_tag.outputs.tag_name }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é…ç½®Gitå®‰å…¨ç›®å½•
        run: |
          git config --global --add safe.directory $env:GITHUB_WORKSPACE
          git config --global --add safe.directory "C:/actions-runner/_work/mailauncher/mailauncher"
          Write-Host "âœ… Git safe directory configured"

      - name: è·å–åŒ…ç‰ˆæœ¬å¹¶åˆ›å»ºå¼€å‘ç‰ˆæœ¬
        id: version
        run: |
          # è¯»å– package.json çš„ç‰ˆæœ¬å·
          $packageJson = Get-Content -Raw -Path "package.json" | ConvertFrom-Json
          $packageVersion = $packageJson.version
          
          # è·å–å½“å‰åŸºç¡€ç‰ˆæœ¬çš„æ‰€æœ‰å¼€å‘ç‰ˆæœ¬æ ‡ç­¾
          $allTags = git tag -l "dev-$packageVersion-dev.*" | Sort-Object -Descending
          
          # è®¡ç®—ä¸‹ä¸€ä¸ªæ„å»ºå·
          $buildNumber = 1
          if ($allTags.Count -gt 0) {
            # ä»æœ€æ–°çš„æ ‡ç­¾ä¸­æå–æ„å»ºå·
            $latestTag = $allTags[0]
            if ($latestTag -match "dev-$packageVersion-dev\.(\d+)$") {
              $buildNumber = [int]$matches[1] + 1
            }
          }
          
          $devVersion = "$packageVersion-dev.$buildNumber"
          
          echo "version=$devVersion" >> $env:GITHUB_OUTPUT
          echo "package_version=$packageVersion" >> $env:GITHUB_OUTPUT
          echo "build_number=$buildNumber" >> $env:GITHUB_OUTPUT
          
          Write-Host "ğŸ“¦ Package Version: $packageVersion"
          Write-Host "ğŸ”§ Dev Version: $devVersion"
          Write-Host "ğŸ”¢ Build Number: $buildNumber"

      - name: åˆ›å»ºå¼€å‘æ ‡ç­¾
        id: create_tag
        run: |
          $tagName = "dev-${{ steps.version.outputs.version }}"
          echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
          
          # æ£€æŸ¥tagæ˜¯å¦å·²å­˜åœ¨
          $existingTags = git ls-remote --tags origin
          if ($existingTags -match "refs/tags/$tagName`$") {
            Write-Host "âš ï¸ Tag $tagName already exists, skipping creation"
          } else {
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag -a "$tagName" -m "ğŸ”§ Auto Dev Build: ${{ steps.version.outputs.version }}"
            git push origin "$tagName"
            Write-Host "âœ… Created and pushed tag: $tagName"
          }

      # å…‹éš†åç«¯ä»“åº“
      - name: å…‹éš†åç«¯ä»“åº“
        run: |
          if (Test-Path "backend") { Remove-Item -Recurse -Force "backend" }
          git clone https://github.com/MaiM-with-u/mailauncher-backend.git backend

      # ç›´æ¥è®¾ç½® Python è·¯å¾„ï¼ˆåŸºäºç³»ç»Ÿå®é™…è·¯å¾„ï¼‰
      - name: ç›´æ¥è®¾ç½®Pythonè·¯å¾„
        run: |
          # åŸºäºæ—¥å¿—è¾“å‡ºçš„å®é™… PATHï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´è·¯å¾„
          $pythonPath = "C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe"
          Write-Host "Trying Python at: $pythonPath"
          
          try {
            # ç›´æ¥ä½¿ç”¨å®Œæ•´è·¯å¾„ï¼Œç»•è¿‡ Test-Path çš„æƒé™æ£€æŸ¥
            $version = & $pythonPath --version 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ“ Python found and working"
              Write-Host "Version: $version"
              echo "PYTHON_EXECUTABLE=$pythonPath" >> $env:GITHUB_ENV
              Write-Host "Python path set successfully"
              exit 0
            } else {
              Write-Host "Python found but failed to execute"
            }
          } catch {
            Write-Host "Failed to execute Python: $($_.Exception.Message)"
          }
          
          # å¦‚æœç›´æ¥è·¯å¾„å¤±è´¥ï¼Œå°è¯•å…¶ä»–ç³»ç»Ÿçº§è·¯å¾„
          $systemPaths = @(
            "C:\Python313\python.exe",
            "C:\Python312\python.exe",
            "C:\Program Files\Python313\python.exe",
            "C:\Program Files\Python312\python.exe"
          )
          
          foreach ($path in $systemPaths) {
            Write-Host "Checking: $path"
            try {
              if (Test-Path $path) {
                $version = & $path --version 2>&1
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "âœ“ Found working Python: $path"
                  Write-Host "Version: $version"
                  echo "PYTHON_EXECUTABLE=$path" >> $env:GITHUB_ENV
                  exit 0
                }
              }
            } catch {
              Write-Host "Cannot access: $path"
            }
          }
          
          Write-Host "Python not found, will try automatic detection..."

      # æ£€æŸ¥å¹¶è®¾ç½® Python ç¯å¢ƒï¼ˆè‡ªæ‰˜ç®¡ runnerï¼‰
      - name: è®¾ç½®Pythonç¯å¢ƒ
        run: |
          # æ£€æŸ¥ä¸Šä¸€æ­¥æ˜¯å¦å·²ç»è®¾ç½®äº† Python
          if ($env:PYTHON_EXECUTABLE) {
            Write-Host "Python already set from previous step: $env:PYTHON_EXECUTABLE"
            exit 0
          }
          
          Write-Host "Searching for Python installation..."
          
          # é¦–å…ˆå°è¯• PATH ä¸­çš„ Python å‘½ä»¤
          $pythonCommands = @("python", "python3", "py")
          foreach ($cmd in $pythonCommands) {
            Write-Host "Trying command: $cmd"
            try {
              $version = & $cmd --version 2>&1
              if ($LASTEXITCODE -eq 0) {
                Write-Host "âœ“ Working Python command found: $cmd"
                Write-Host "Version: $version"
                echo "PYTHON_EXECUTABLE=$cmd" >> $env:GITHUB_ENV
                Write-Host "=== Python Setup Complete ==="
                exit 0
              }
            } catch {
              Write-Host "âœ— Command not found or failed: $cmd"
            }
          }
          
          # å¦‚æœå‘½ä»¤éƒ½å¤±è´¥äº†ï¼Œå°è¯•ç³»ç»Ÿçº§è·¯å¾„ï¼ˆé¿å…ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼‰
          $systemPaths = @(
            "C:\Python*\python.exe",
            "C:\Program Files\Python*\python.exe",
            "C:\Program Files (x86)\Python*\python.exe"
          )
          
          $pythonFound = $false
          foreach ($path in $systemPaths) {
            Write-Host "Checking system path: $path"
            try {
              $resolvedPaths = Get-ChildItem -Path $path -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending
              if ($resolvedPaths) {
                foreach ($resolvedPath in $resolvedPaths) {
                  Write-Host "Found potential Python at: $($resolvedPath.FullName)"
                  try {
                    $version = & $resolvedPath.FullName --version 2>&1
                    if ($LASTEXITCODE -eq 0) {
                      Write-Host "âœ“ Working Python found: $($resolvedPath.FullName)"
                      Write-Host "Version: $version"
                      echo "PYTHON_EXECUTABLE=$($resolvedPath.FullName)" >> $env:GITHUB_ENV
                      $pythonFound = $true
                      break
                    }
                  } catch {
                    Write-Host "âœ— Failed to execute: $($resolvedPath.FullName)"
                  }
                }
                if ($pythonFound) { break }
              }
            } catch {
              Write-Host "âœ— Error checking path: $path"
            }
          }
          
          if (-not $pythonFound) {
            Write-Host "=== Python Search Failed ==="
            Write-Host "Current working directory: $(Get-Location)"
            Write-Host "Current user: $env:USERNAME"
            Write-Host "PATH variable:"
            $env:PATH -split ';' | ForEach-Object { Write-Host "  $_" }
            Write-Error "Python not found! Please ensure Python is installed and accessible."
            exit 1
          }
          
          Write-Host "=== Python Setup Complete ==="
          Write-Host "Python executable: $env:PYTHON_EXECUTABLE"

      # æ¸…ç†å¯èƒ½çš„ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ä½†æ¨èï¼‰
      - name: æ¸…ç†Pythonç¼“å­˜
        run: |
          Write-Host "Cleaning Python cache..."
          Write-Host "Using Python: $env:PYTHON_EXECUTABLE"
          & $env:PYTHON_EXECUTABLE -m pip cache purge
          Write-Host "Cache cleaned."
          
      # ç¼“å­˜ pip ä¾èµ–
      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # å®‰è£…åç«¯æ„å»ºä¾èµ–
      - name: å®‰è£…åç«¯ä¾èµ–
        run: |
          cd backend
          & $env:PYTHON_EXECUTABLE -m pip install --upgrade pip
          & $env:PYTHON_EXECUTABLE -m pip install -r requirements.txt
          & $env:PYTHON_EXECUTABLE -m pip install pyinstaller
          
      # åˆ›å»ºæ•°æ®ç›®å½•
      - name: åˆ›å»ºåç«¯æ•°æ®ç›®å½•
        run: |
          cd backend
          if (!(Test-Path "data")) { New-Item -ItemType Directory -Path "data" }
          
      # æ„å»º Windows åç«¯
      - name: æ„å»ºWindowsåç«¯
        run: |
          cd backend
          Write-Host "Using Python: $env:PYTHON_EXECUTABLE"
          & $env:PYTHON_EXECUTABLE -m PyInstaller main.spec
          
      # å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶åˆ° Tauri binaries ç›®å½•
      - name: å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶åˆ°Tauriç›®å½•
        run: |
          if (!(Test-Path "src-tauri\binaries")) { New-Item -ItemType Directory -Path "src-tauri\binaries" -Force }
          Copy-Item "backend\dist\MaiLauncher-Backend.exe" "src-tauri\binaries\MaiLauncher-Backend-x86_64-pc-windows-msvc.exe"

      # æ£€æŸ¥å¹¶å®‰è£… Node.js
      - name: è®¾ç½®Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          
      # è®¾ç½® pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest
          run_install: false

      # å®‰è£…å‰ç«¯ä¾èµ–
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      # ä¸´æ—¶æ›´æ–°ç‰ˆæœ¬å·ç”¨äºæ„å»º
      - name: ä¸´æ—¶æ›´æ–°ç‰ˆæœ¬å·ç”¨äºæ„å»º
        run: |
          $devVersion = "${{ steps.version.outputs.version }}"
          
          # ä¸´æ—¶æ›´æ–°package.jsonç‰ˆæœ¬å·ï¼ˆä»…ç”¨äºæ„å»ºï¼Œä¸æäº¤ï¼‰
          $packageJson = Get-Content -Raw -Path "package.json" | ConvertFrom-Json
          $originalVersion = $packageJson.version
          $packageJson.version = $devVersion
          $packageJson | ConvertTo-Json -Depth 100 | Set-Content -Path "package.json"
          Write-Host "ğŸ”§ ä¸´æ—¶æ›´æ–° package.json ç‰ˆæœ¬å·: $originalVersion -> $devVersion"
          
          # ä¸´æ—¶æ›´æ–°Cargo.tomlç‰ˆæœ¬å·ï¼ˆä»…ç”¨äºæ„å»ºï¼Œä¸æäº¤ï¼‰
          $cargoToml = Get-Content -Path "src-tauri\Cargo.toml"
          $cargoToml = $cargoToml -replace '^version = ".*"', "version = `"$devVersion`""
          $cargoToml | Set-Content -Path "src-tauri\Cargo.toml"
          Write-Host "ğŸ”§ ä¸´æ—¶æ›´æ–° Cargo.toml ç‰ˆæœ¬å·ä¸º: $devVersion"

      # æ„å»º Tauri åº”ç”¨ï¼ˆDevç‰ˆæœ¬ï¼‰
      - name: æ„å»ºTauriåº”ç”¨ï¼ˆå¼€å‘ç‰ˆæœ¬ï¼‰
        run: |
          Write-Host "ğŸ”§ Building Dev Version: ${{ steps.version.outputs.version }}"
          pnpm run build:dev
          pnpm tauri build
          
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ å¼€å‘ç‰ˆæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dev-build-windows-${{ steps.version.outputs.version }}
          path: src-tauri/target/release/bundle/
          retention-days: 7

      - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
        run: |
          @"
          # ğŸ”§ å¼€å‘ç‰ˆæœ¬æ„å»º - ${{ steps.version.outputs.version }}
          
          ## ğŸ“‹ æ„å»ºä¿¡æ¯
          - **åŸºç¡€ç‰ˆæœ¬**: ${{ steps.version.outputs.package_version }}
          - **æ„å»ºæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          - **æ„å»ºç±»å‹**: Development
          - **æäº¤SHA**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          è¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„å¼€å‘ç‰ˆæœ¬ï¼Œä»…ç”¨äºæµ‹è¯•å’Œå¼€å‘ç›®çš„ã€‚
          - å¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„åŠŸèƒ½
          - ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨
          - è¯¥ç‰ˆæœ¬ä¼šå®šæœŸæ¸…ç†
          
          ## ğŸ“¦ ä¸‹è½½
          - Windows: MSI, EXE å®‰è£…åŒ…
          
          ---
          *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
          "@ | Out-File -FilePath "release_note.md" -Encoding UTF8

      - name: åˆ›å»ºå¼€å‘ç‰ˆå‘å¸ƒ
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_tag.outputs.tag_name }}
          name: "ğŸ”§ Dev Build - ${{ steps.version.outputs.version }}"
          body_path: release_note.md
          files: |
            src-tauri/target/release/bundle/**/*.msi
            src-tauri/target/release/bundle/**/*.exe
          prerelease: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-old-dev-releases:
    name: æ¸…ç†æ—§å¼€å‘ç‰ˆæœ¬
    needs: [build-windows]
    runs-on: [self-hosted, windows, x64]
    if: always()
    
    steps:
      - name: æ¸…ç†æ—§çš„å¼€å‘ç‰ˆå‘å¸ƒ
        run: |
          Write-Host "ğŸ§¹ Cleaning up old dev releases..."
          
          # è·å–æ‰€æœ‰å¼€å‘ç‰ˆæœ¬çš„releasesï¼ˆæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼‰
          $releases = gh release list --limit 50 --json tagName,createdAt,prerelease,id | ConvertFrom-Json
          $devReleases = $releases | Where-Object { $_.prerelease -eq $true -and $_.tagName -match "^dev-" } | Sort-Object createdAt -Descending
          
          Write-Host "Found $($devReleases.Count) dev releases"
          
          # ä¿ç•™æœ€æ–°çš„5ä¸ªå¼€å‘ç‰ˆæœ¬ï¼Œåˆ é™¤å…¶ä½™çš„
          if ($devReleases.Count -gt 5) {
            $releasesToDelete = $devReleases | Select-Object -Skip 5
            
            foreach ($release in $releasesToDelete) {
              $tagName = $release.tagName
              Write-Host "ğŸ—‘ï¸ Deleting old dev release: $tagName"
              
              try {
                # åˆ é™¤release
                gh release delete $tagName --yes
                
                # åˆ é™¤tag
                git push --delete origin $tagName
                
                Write-Host "âœ… Deleted: $tagName"
              } catch {
                Write-Host "âŒ Failed to delete: $tagName - $($_.Exception.Message)"
              }
            }
          } else {
            Write-Host "âœ… No cleanup needed (less than 5 dev releases)"
          }
          
          Write-Host "âœ… Cleanup completed. Kept $([Math]::Min(5, $($devReleases.Count))) dev releases."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
