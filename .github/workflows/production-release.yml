name: æ„å»ºç”Ÿäº§ç‰ˆæœ¬å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      version_mode:
        description: 'ç‰ˆæœ¬é€’å¢æ¨¡å¼'
        required: true
        type: choice
        options:
          - 'manual'
          - 'patch'
          - 'minor'
          - 'major'
        default: 'manual'
      version:
        description: 'æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å· (ä»…å½“é€‰æ‹©manualæ—¶ç”Ÿæ•ˆï¼Œå¦‚: 1.0.0)'
        required: false
        type: string
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜ (ç®€çŸ­æè¿°)'
        required: false
        type: string
        default: 'æ­£å¼ç‰ˆæœ¬å‘å¸ƒ'
      is_major_release:
        description: 'æ˜¯å¦ä¸ºé‡å¤§ç‰ˆæœ¬å‘å¸ƒ'
        required: true
        type: boolean
        default: false

env:
  VITE_BUILD_TYPE: production
  # è®¾ç½® PowerShell å’Œç³»ç»Ÿç¼–ç 
  POWERSHELL_OUTPUT_ENCODING: utf8
  PYTHONIOENCODING: utf-8

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  actions: read

# é™åˆ¶å¹¶å‘æ‰§è¡Œï¼Œé˜²æ­¢ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    name: æ„å»ºWindowsç‰ˆæœ¬
    runs-on: [self-hosted, windows, x64] # ä»…ä½¿ç”¨è‡ªæ‰˜ç®¡çš„ Windows runner
    
    outputs:
      version: ${{ steps.validate.outputs.version }}
      tag_name: ${{ steps.validate.outputs.tag_name }}
    
    steps:
      - name: è®¾ç½®PowerShellç¼–ç 
        run: |
          # è®¾ç½®PowerShellæ§åˆ¶å°ç¼–ç ä¸ºUTF-8
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.Encoding]::UTF8
          $OutputEncoding = [console]::InputEncoding = [console]::OutputEncoding = New-Object System.Text.UTF8Encoding
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "POWERSHELL_TELEMETRY_OPTOUT=1" >> $env:GITHUB_ENV
          echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
          
          Write-Host "âœ… PowerShell encoding set to UTF-8"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯ç‰ˆæœ¬æ ¼å¼
        id: validate
        run: |
          $VERSION_MODE = "${{ github.event.inputs.version_mode }}"
          
          if ($VERSION_MODE -eq "manual") {
            $VERSION = "${{ github.event.inputs.version }}"
            if ([string]::IsNullOrEmpty($VERSION)) {
              Write-Host "âŒ æ‰‹åŠ¨æ¨¡å¼ä¸‹å¿…é¡»æä¾›ç‰ˆæœ¬å·ï¼"
              exit 1
            }
            
            # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ (è¯­ä¹‰åŒ–ç‰ˆæœ¬)
            if ($VERSION -notmatch "^[0-9]+\.[0-9]+\.[0-9]+$") {
              Write-Host "âŒ æ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼: $VERSION"
              Write-Host "âœ… æ­£ç¡®æ ¼å¼ç¤ºä¾‹: 1.0.0, 0.2.1, 2.1.0"
              exit 1
            }
          } else {
            # è‡ªåŠ¨é€’å¢æ¨¡å¼
            Write-Host "ğŸ”„ è‡ªåŠ¨é€’å¢æ¨¡å¼: $VERSION_MODE"
            
            # è·å–æ‰€æœ‰ç”Ÿäº§ç‰ˆæœ¬æ ‡ç­¾
            $allTags = git tag -l "v*.*.*" | Where-Object { $_ -match "^v[0-9]+\.[0-9]+\.[0-9]+$" } | Sort-Object -Descending
            
            if ($allTags.Count -eq 0) {
              # å¦‚æœæ²¡æœ‰ç”Ÿäº§ç‰ˆæœ¬æ ‡ç­¾ï¼Œä»package.jsonè¯»å–å½“å‰ç‰ˆæœ¬
              $packageJson = Get-Content -Raw -Path "package.json" -Encoding UTF8 | ConvertFrom-Json
              $currentVersion = $packageJson.version -replace "-.*$", ""  # ç§»é™¤é¢„å‘å¸ƒåç¼€
            } else {
              # ä»æœ€æ–°æ ‡ç­¾è·å–å½“å‰ç‰ˆæœ¬
              $latestTag = $allTags[0]
              $currentVersion = $latestTag -replace "^v", ""
            }
            
            Write-Host "ğŸ“¦ Current Version: $currentVersion"
            
            # è§£æç‰ˆæœ¬å·
            if ($currentVersion -match "^(\d+)\.(\d+)\.(\d+)$") {
              $major = [int]$matches[1]
              $minor = [int]$matches[2]
              $patch = [int]$matches[3]
              
              # æ ¹æ®æ¨¡å¼é€’å¢ç‰ˆæœ¬å·
              switch ($VERSION_MODE) {
                "patch" { $patch++; Write-Host "ğŸ”§ Incrementing patch version" }
                "minor" { $minor++; $patch = 0; Write-Host "âœ¨ Incrementing minor version" }
                "major" { $major++; $minor = 0; $patch = 0; Write-Host "ğŸš€ Incrementing major version" }
              }
              
              $VERSION = "$major.$minor.$patch"
            } else {
              Write-Host "âŒ æ— æ³•è§£æå½“å‰ç‰ˆæœ¬å·: $currentVersion"
              exit 1
            }
          }
          
          $tagName = "v$VERSION"
          
          # æ£€æŸ¥tagæ˜¯å¦å·²å­˜åœ¨
          $existingTags = git ls-remote --tags origin
          if ($existingTags -match "refs/tags/$tagName`$") {
            Write-Host "âŒ ç‰ˆæœ¬æ ‡ç­¾ $tagName å·²å­˜åœ¨ï¼"
            if ($VERSION_MODE -ne "manual") {
              Write-Host "è¿™å¯èƒ½æ˜¯è‡ªåŠ¨é€’å¢é€»è¾‘çš„é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç°æœ‰æ ‡ç­¾ã€‚"
            } else {
              Write-Host "è¯·ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬å·ã€‚"
            }
            exit 1
          }
          
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
          echo "version_mode=$VERSION_MODE" >> $env:GITHUB_OUTPUT
          Write-Host "âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡: $VERSION (æ¨¡å¼: $VERSION_MODE)"

      - name: æ›´æ–°package.jsonå’ŒCargo.tomlç‰ˆæœ¬
        run: |
          $VERSION = "${{ steps.validate.outputs.version }}"
          
          # æ›´æ–°package.jsonä¸­çš„ç‰ˆæœ¬å·
          $packageJson = Get-Content -Raw -Path "package.json" -Encoding UTF8 | ConvertFrom-Json
          $packageJson.version = $VERSION
          $packageJson | ConvertTo-Json -Depth 100 | Set-Content -Path "package.json" -Encoding UTF8
          Write-Host "âœ… å·²æ›´æ–° package.json ç‰ˆæœ¬å·ä¸º: $VERSION"
          
          # æ›´æ–°Cargo.tomlä¸­çš„ç‰ˆæœ¬å·
          $cargoToml = Get-Content -Path "src-tauri\Cargo.toml" -Encoding UTF8
          $cargoToml = $cargoToml -replace '^version = ".*"', "version = `"$VERSION`""
          $cargoToml | Set-Content -Path "src-tauri\Cargo.toml" -Encoding UTF8
          Write-Host "âœ… å·²æ›´æ–° Cargo.toml ç‰ˆæœ¬å·ä¸º: $VERSION"

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°
        run: |
          $VERSION = "${{ steps.validate.outputs.version }}"
          
          # é…ç½® git ç”¨æˆ·ï¼ˆä½¿ç”¨ GitHub Actions botï¼‰
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æäº¤ç‰ˆæœ¬æ›´æ–°
          git add package.json
          git commit -m "ğŸ”– Bump version to $VERSION for production release"
          git push origin main
          
          Write-Host "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤å¹¶æ¨é€"

      # å…‹éš†åç«¯ä»“åº“
      - name: å…‹éš†åç«¯ä»“åº“
        run: |
          if (Test-Path "backend") { Remove-Item -Recurse -Force "backend" }
          git clone https://github.com/MaiM-with-u/mailauncher-backend.git backend

      # ç›´æ¥è®¾ç½® Python è·¯å¾„ï¼ˆåŸºäºç³»ç»Ÿå®é™…è·¯å¾„ï¼‰
      - name: ç›´æ¥è®¾ç½®Pythonè·¯å¾„
        run: |
          # åŸºäºæ—¥å¿—è¾“å‡ºçš„å®é™… PATHï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´è·¯å¾„
          $pythonPath = "C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe"
          Write-Host "Trying Python at: $pythonPath"
          
          try {
            # ç›´æ¥ä½¿ç”¨å®Œæ•´è·¯å¾„ï¼Œç»•è¿‡ Test-Path çš„æƒé™æ£€æŸ¥
            $version = & $pythonPath --version 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ“ Python found and working"
              Write-Host "Version: $version"
              echo "PYTHON_EXECUTABLE=$pythonPath" >> $env:GITHUB_ENV
              Write-Host "Python path set successfully"
              exit 0
            } else {
              Write-Host "Python found but failed to execute"
            }
          } catch {
            Write-Host "Failed to execute Python: $($_.Exception.Message)"
          }
          
          # å¦‚æœç›´æ¥è·¯å¾„å¤±è´¥ï¼Œå°è¯•å…¶ä»–ç³»ç»Ÿçº§è·¯å¾„
          $systemPaths = @(
            "C:\Python313\python.exe",
            "C:\Python312\python.exe",
            "C:\Program Files\Python313\python.exe",
            "C:\Program Files\Python312\python.exe"
          )
          
          foreach ($path in $systemPaths) {
            Write-Host "Checking: $path"
            try {
              if (Test-Path $path) {
                $version = & $path --version 2>&1
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "âœ“ Found working Python: $path"
                  Write-Host "Version: $version"
                  echo "PYTHON_EXECUTABLE=$path" >> $env:GITHUB_ENV
                  exit 0
                }
              }
            } catch {
              Write-Host "Cannot access: $path"
            }
          }
          
          Write-Host "Python not found, will try automatic detection..."

      # æ£€æŸ¥å¹¶è®¾ç½® Python ç¯å¢ƒï¼ˆè‡ªæ‰˜ç®¡ runnerï¼‰
      - name: è®¾ç½®Pythonç¯å¢ƒ
        run: |
          # æ£€æŸ¥ä¸Šä¸€æ­¥æ˜¯å¦å·²ç»è®¾ç½®äº† Python
          if ($env:PYTHON_EXECUTABLE) {
            Write-Host "Python already set from previous step: $env:PYTHON_EXECUTABLE"
            exit 0
          }
          
          Write-Host "Searching for Python installation..."
          
          # é¦–å…ˆå°è¯• PATH ä¸­çš„ Python å‘½ä»¤
          $pythonCommands = @("python", "python3", "py")
          foreach ($cmd in $pythonCommands) {
            Write-Host "Trying command: $cmd"
            try {
              $version = & $cmd --version 2>&1
              if ($LASTEXITCODE -eq 0) {
                Write-Host "âœ“ Working Python command found: $cmd"
                Write-Host "Version: $version"
                echo "PYTHON_EXECUTABLE=$cmd" >> $env:GITHUB_ENV
                Write-Host "=== Python Setup Complete ==="
                exit 0
              }
            } catch {
              Write-Host "âœ— Command not found or failed: $cmd"
            }
          }
          
          # å¦‚æœå‘½ä»¤éƒ½å¤±è´¥äº†ï¼Œå°è¯•ç³»ç»Ÿçº§è·¯å¾„ï¼ˆé¿å…ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼‰
          $systemPaths = @(
            "C:\Python*\python.exe",
            "C:\Program Files\Python*\python.exe",
            "C:\Program Files (x86)\Python*\python.exe"
          )
          
          $pythonFound = $false
          foreach ($path in $systemPaths) {
            Write-Host "Checking system path: $path"
            try {
              $resolvedPaths = Get-ChildItem -Path $path -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending
              if ($resolvedPaths) {
                foreach ($resolvedPath in $resolvedPaths) {
                  Write-Host "Found potential Python at: $($resolvedPath.FullName)"
                  try {
                    $version = & $resolvedPath.FullName --version 2>&1
                    if ($LASTEXITCODE -eq 0) {
                      Write-Host "âœ“ Working Python found: $($resolvedPath.FullName)"
                      Write-Host "Version: $version"
                      echo "PYTHON_EXECUTABLE=$($resolvedPath.FullName)" >> $env:GITHUB_ENV
                      $pythonFound = $true
                      break
                    }
                  } catch {
                    Write-Host "âœ— Failed to execute: $($resolvedPath.FullName)"
                  }
                }
                if ($pythonFound) { break }
              }
            } catch {
              Write-Host "âœ— Error checking path: $path"
            }
          }
          
          if (-not $pythonFound) {
            Write-Host "=== Python Search Failed ==="
            Write-Host "Current working directory: $(Get-Location)"
            Write-Host "Current user: $env:USERNAME"
            Write-Host "PATH variable:"
            $env:PATH -split ';' | ForEach-Object { Write-Host "  $_" }
            Write-Error "Python not found! Please ensure Python is installed and accessible."
            exit 1
          }
          
          Write-Host "=== Python Setup Complete ==="
          Write-Host "Python executable: $env:PYTHON_EXECUTABLE"

      # æ¸…ç†å¯èƒ½çš„ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ä½†æ¨èï¼‰
      - name: æ¸…ç†Pythonç¼“å­˜
        run: |
          Write-Host "Cleaning Python cache..."
          Write-Host "Using Python: $env:PYTHON_EXECUTABLE"
          & $env:PYTHON_EXECUTABLE -m pip cache purge
          Write-Host "Cache cleaned."
          
      # ç¼“å­˜ pip ä¾èµ–
      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # å®‰è£…åç«¯æ„å»ºä¾èµ–
      - name: å®‰è£…åç«¯ä¾èµ–
        run: |
          cd backend
          & $env:PYTHON_EXECUTABLE -m pip install --upgrade pip
          & $env:PYTHON_EXECUTABLE -m pip install -r requirements.txt
          & $env:PYTHON_EXECUTABLE -m pip install pyinstaller
          
      # åˆ›å»ºæ•°æ®ç›®å½•
      - name: åˆ›å»ºåç«¯æ•°æ®ç›®å½•
        run: |
          cd backend
          if (!(Test-Path "data")) { New-Item -ItemType Directory -Path "data" }
          
      # æ„å»º Windows åç«¯
      - name: æ„å»ºWindowsåç«¯
        run: |
          cd backend
          Write-Host "Using Python: $env:PYTHON_EXECUTABLE"
          & $env:PYTHON_EXECUTABLE -m PyInstaller main.spec
          
      # å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶åˆ° Tauri binaries ç›®å½•
      - name: å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶åˆ°Tauriç›®å½•
        run: |
          if (!(Test-Path "src-tauri\binaries")) { New-Item -ItemType Directory -Path "src-tauri\binaries" -Force }
          Copy-Item "backend\dist\MaiLauncher-Backend.exe" "src-tauri\binaries\MaiLauncher-Backend-x86_64-pc-windows-msvc.exe"

      # æ£€æŸ¥å¹¶å®‰è£… Node.js
      - name: è®¾ç½®Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          
      # è®¾ç½® pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest
          run_install: true

      # æ„å»º Tauri åº”ç”¨ï¼ˆProductionç‰ˆæœ¬ï¼‰
      - name: æ„å»ºTauriåº”ç”¨ï¼ˆç”Ÿäº§ç‰ˆæœ¬ï¼‰
        run: |
          Write-Host "ğŸš€ Building Production Version for Windows: ${{ steps.validate.outputs.version }}"
          pnpm run build:prod
          pnpm tauri build
          
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆç”Ÿäº§ç‰ˆWindowsï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: production-windows-${{ steps.validate.outputs.version }}
          path: src-tauri/target/release/bundle/

  create-release:
    name: åˆ›å»ºå‘å¸ƒ
    needs: [build-windows]
    runs-on: [self-hosted, windows, x64] # ä½¿ç”¨ç›¸åŒçš„è‡ªæ‰˜ç®¡ runner
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½Windowsæ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: production-windows-${{ needs.build-windows.outputs.version }}
          path: ./artifacts/windows

      - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
        run: |
          @"
          # ğŸ‰ æ­£å¼ç‰ˆæœ¬å‘å¸ƒ - ${{ needs.build-windows.outputs.version }}
          
          ${{ github.event.inputs.release_notes }}
          
          ## ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬å·**: ${{ needs.build-windows.outputs.version }}
          - **æ„å»ºå¹³å°**: Windows (è‡ªæ‰˜ç®¡)
          - **æ„å»ºç±»å‹**: Production
          - **å‘å¸ƒæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          - **é‡å¤§ç‰ˆæœ¬**: ${{ github.event.inputs.is_major_release }}
          
          ## ğŸ¯ åŒ…å«çš„æ„å»ºäº§ç‰©
          - Windows å¯æ‰§è¡Œæ–‡ä»¶å’Œå®‰è£…åŒ…
          
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š
          - **Windows**: ä¸‹è½½ .msi æˆ– .exe æ–‡ä»¶
          
          > âœ… è¿™æ˜¯ä¸€ä¸ªç¨³å®šçš„æ­£å¼ç‰ˆæœ¬ï¼Œæ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚
          "@ | Out-File -FilePath "release_note.md" -Encoding UTF8

      - name: åˆ›å»ºç”Ÿäº§ç‰ˆå‘å¸ƒ
        uses: softprops/action-gh-release@v1
        id: create_release
        with:
          tag_name: ${{ needs.build-windows.outputs.tag_name }}
          name: "ğŸ‰ Release - ${{ needs.build-windows.outputs.version }}"
          body_path: release_note.md
          files: |
            ./artifacts/windows/**/*.msi
            ./artifacts/windows/**/*.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        run: |
          $tagName = "${{ needs.build-windows.outputs.tag_name }}"
          
          Write-Host "ğŸ·ï¸ Creating tag: $tagName"
          
          # é…ç½® git ç”¨æˆ·ï¼ˆä½¿ç”¨ GitHub Actions botï¼‰
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # åˆ›å»ºæ ‡ç­¾
          git tag -a "$tagName" -m "ğŸ‰ Production Release: ${{ needs.build-windows.outputs.version }}"
          
          # æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“
          git push origin "$tagName"
          
          Write-Host "âœ… Tag created and pushed successfully"

      - name: Post-release actions
        run: |
          Write-Host "ğŸ‰ Production release completed successfully!"
          Write-Host "Version: ${{ needs.build-windows.outputs.version }}"
          Write-Host "Tag: ${{ needs.build-windows.outputs.tag_name }}"
          
          # å¦‚æœæ˜¯é‡å¤§ç‰ˆæœ¬å‘å¸ƒï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–çš„é€šçŸ¥é€»è¾‘
          if ("${{ github.event.inputs.is_major_release }}" -eq "true") {
            Write-Host "ğŸš€ This is a major release!"
            # è¿™é‡Œå¯ä»¥æ·»åŠ å‘é€é€šçŸ¥ã€æ›´æ–°æ–‡æ¡£ç­‰é€»è¾‘
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
