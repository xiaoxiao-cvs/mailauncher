name: æ„å»ºé¢„è§ˆç‰ˆæœ¬

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: 'ç‰ˆæœ¬å·è¦†ç›– (å¯é€‰ï¼Œå¦‚: 0.1.0-preview.3)'
        required: false
        type: string
      create_release:
        description: 'åˆ›å»ºGitHub Release'
        required: true
        type: boolean
        default: true

env:
  VITE_BUILD_TYPE: preview

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  actions: read

# é™åˆ¶å¹¶å‘æ‰§è¡Œï¼Œé˜²æ­¢ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    name: æ„å»ºWindowsç‰ˆæœ¬
    runs-on: [self-hosted, windows, x64] # ä»…ä½¿ç”¨è‡ªæ‰˜ç®¡çš„ Windows runner
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç¡®å®šç‰ˆæœ¬å·
        id: version
        run: |
          if ("${{ github.event.inputs.version_override }}" -ne "") {
            $VERSION = "${{ github.event.inputs.version_override }}"
            Write-Host "ğŸ”§ Using override version: $VERSION"
          } else {
            # è¯»å– package.json çš„ç‰ˆæœ¬å·
            $packageJson = Get-Content -Raw -Path "package.json" | ConvertFrom-Json
            $packageVersion = $packageJson.version
            
            # ç§»é™¤å¯èƒ½å­˜åœ¨çš„ preview åç¼€ï¼Œè·å–åŸºç¡€ç‰ˆæœ¬
            $baseVersion = $packageVersion -replace "-preview.*$", ""
            
            # è·å–å½“å‰åŸºç¡€ç‰ˆæœ¬çš„æ‰€æœ‰é¢„è§ˆç‰ˆæœ¬æ ‡ç­¾
            $allTags = git tag -l "v$baseVersion-preview.*" | Sort-Object -Descending
            
            # è®¡ç®—ä¸‹ä¸€ä¸ªé¢„è§ˆç‰ˆæœ¬å·
            $previewNumber = 1
            if ($allTags.Count -gt 0) {
              # ä»æœ€æ–°çš„æ ‡ç­¾ä¸­æå–é¢„è§ˆç‰ˆæœ¬å·
              $latestTag = $allTags[0]
              if ($latestTag -match "v$baseVersion-preview\.(\d+)$") {
                $previewNumber = [int]$matches[1] + 1
              }
            }
            
            $VERSION = "$baseVersion-preview.$previewNumber"
            Write-Host "ğŸ“¦ Base Version: $baseVersion"
            Write-Host "ï¿½ Preview Number: $previewNumber"
            Write-Host "ğŸ¯ Generated Version: $VERSION"
          }
          
          $tagName = "v$VERSION"
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
          Write-Host "ğŸ·ï¸ Tag name: $tagName"

      # å…‹éš†åç«¯ä»“åº“
      - name: å…‹éš†åç«¯ä»“åº“
        run: |
          if (Test-Path "backend") { Remove-Item -Recurse -Force "backend" }
          git clone https://github.com/MaiM-with-u/mailauncher-backend.git backend

      # ç›´æ¥è®¾ç½® Python è·¯å¾„ï¼ˆåŸºäºç³»ç»Ÿå®é™…è·¯å¾„ï¼‰
      - name: ç›´æ¥è®¾ç½®Pythonè·¯å¾„
        run: |
          # åŸºäºæ—¥å¿—è¾“å‡ºçš„å®é™… PATHï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´è·¯å¾„
          $pythonPath = "C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe"
          Write-Host "Trying Python at: $pythonPath"
          
          try {
            # ç›´æ¥ä½¿ç”¨å®Œæ•´è·¯å¾„ï¼Œç»•è¿‡ Test-Path çš„æƒé™æ£€æŸ¥
            $version = & $pythonPath --version 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ“ Python found and working"
              Write-Host "Version: $version"
              echo "PYTHON_EXECUTABLE=$pythonPath" >> $env:GITHUB_ENV
              Write-Host "Python path set successfully"
              exit 0
            } else {
              Write-Host "Python found but failed to execute"
            }
          } catch {
            Write-Host "Failed to execute Python: $($_.Exception.Message)"
          }
          
          # å¦‚æœç›´æ¥è·¯å¾„å¤±è´¥ï¼Œå°è¯•å…¶ä»–ç³»ç»Ÿçº§è·¯å¾„
          $systemPaths = @(
            "C:\Python313\python.exe",
            "C:\Python312\python.exe",
            "C:\Program Files\Python313\python.exe",
            "C:\Program Files\Python312\python.exe"
          )
          
          foreach ($path in $systemPaths) {
            Write-Host "Checking: $path"
            try {
              if (Test-Path $path) {
                $version = & $path --version 2>&1
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "âœ“ Found working Python: $path"
                  Write-Host "Version: $version"
                  echo "PYTHON_EXECUTABLE=$path" >> $env:GITHUB_ENV
                  exit 0
                }
              }
            } catch {
              Write-Host "Cannot access: $path"
            }
          }
          
          Write-Host "Python not found, will try automatic detection..."

      # æ£€æŸ¥å¹¶è®¾ç½® Python ç¯å¢ƒï¼ˆè‡ªæ‰˜ç®¡ runnerï¼‰
      - name: è®¾ç½®Pythonç¯å¢ƒ
        run: |
          # æ£€æŸ¥ä¸Šä¸€æ­¥æ˜¯å¦å·²ç»è®¾ç½®äº† Python
          if ($env:PYTHON_EXECUTABLE) {
            Write-Host "Python already set from previous step: $env:PYTHON_EXECUTABLE"
            exit 0
          }
          
          Write-Host "Searching for Python installation..."
          
          # é¦–å…ˆå°è¯• PATH ä¸­çš„ Python å‘½ä»¤
          $pythonCommands = @("python", "python3", "py")
          foreach ($cmd in $pythonCommands) {
            Write-Host "Trying command: $cmd"
            try {
              $version = & $cmd --version 2>&1
              if ($LASTEXITCODE -eq 0) {
                Write-Host "âœ“ Working Python command found: $cmd"
                Write-Host "Version: $version"
                echo "PYTHON_EXECUTABLE=$cmd" >> $env:GITHUB_ENV
                Write-Host "=== Python Setup Complete ==="
                exit 0
              }
            } catch {
              Write-Host "âœ— Command not found or failed: $cmd"
            }
          }
          
          # å¦‚æœå‘½ä»¤éƒ½å¤±è´¥äº†ï¼Œå°è¯•ç³»ç»Ÿçº§è·¯å¾„ï¼ˆé¿å…ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼‰
          $systemPaths = @(
            "C:\Python*\python.exe",
            "C:\Program Files\Python*\python.exe",
            "C:\Program Files (x86)\Python*\python.exe"
          )
          
          $pythonFound = $false
          foreach ($path in $systemPaths) {
            Write-Host "Checking system path: $path"
            try {
              $resolvedPaths = Get-ChildItem -Path $path -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending
              if ($resolvedPaths) {
                foreach ($resolvedPath in $resolvedPaths) {
                  Write-Host "Found potential Python at: $($resolvedPath.FullName)"
                  try {
                    $version = & $resolvedPath.FullName --version 2>&1
                    if ($LASTEXITCODE -eq 0) {
                      Write-Host "âœ“ Working Python found: $($resolvedPath.FullName)"
                      Write-Host "Version: $version"
                      echo "PYTHON_EXECUTABLE=$($resolvedPath.FullName)" >> $env:GITHUB_ENV
                      $pythonFound = $true
                      break
                    }
                  } catch {
                    Write-Host "âœ— Failed to execute: $($resolvedPath.FullName)"
                  }
                }
                if ($pythonFound) { break }
              }
            } catch {
              Write-Host "âœ— Error checking path: $path"
            }
          }
          
          if (-not $pythonFound) {
            Write-Host "=== Python Search Failed ==="
            Write-Host "Current working directory: $(Get-Location)"
            Write-Host "Current user: $env:USERNAME"
            Write-Host "PATH variable:"
            $env:PATH -split ';' | ForEach-Object { Write-Host "  $_" }
            Write-Error "Python not found! Please ensure Python is installed and accessible."
            exit 1
          }
          
          Write-Host "=== Python Setup Complete ==="
          Write-Host "Python executable: $env:PYTHON_EXECUTABLE"

      # æ¸…ç†å¯èƒ½çš„ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ä½†æ¨èï¼‰
      - name: æ¸…ç†Pythonç¼“å­˜
        run: |
          Write-Host "Cleaning Python cache..."
          Write-Host "Using Python: $env:PYTHON_EXECUTABLE"
          & $env:PYTHON_EXECUTABLE -m pip cache purge
          Write-Host "Cache cleaned."
          
      # ç¼“å­˜ pip ä¾èµ–
      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # å®‰è£…åç«¯æ„å»ºä¾èµ–
      - name: å®‰è£…åç«¯ä¾èµ–
        run: |
          cd backend
          & $env:PYTHON_EXECUTABLE -m pip install --upgrade pip
          & $env:PYTHON_EXECUTABLE -m pip install -r requirements.txt
          & $env:PYTHON_EXECUTABLE -m pip install pyinstaller
          
      # åˆ›å»ºæ•°æ®ç›®å½•
      - name: åˆ›å»ºåç«¯æ•°æ®ç›®å½•
        run: |
          cd backend
          if (!(Test-Path "data")) { New-Item -ItemType Directory -Path "data" }
          
      # æ„å»º Windows åç«¯
      - name: æ„å»ºWindowsåç«¯
        run: |
          cd backend
          Write-Host "Using Python: $env:PYTHON_EXECUTABLE"
          & $env:PYTHON_EXECUTABLE -m PyInstaller main.spec
          
      # å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶åˆ° Tauri binaries ç›®å½•
      - name: å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶åˆ°Tauriç›®å½•
        run: |
          if (!(Test-Path "src-tauri\binaries")) { New-Item -ItemType Directory -Path "src-tauri\binaries" -Force }
          Copy-Item "backend\dist\MaiLauncher-Backend.exe" "src-tauri\binaries\MaiLauncher-Backend-x86_64-pc-windows-msvc.exe"

      # æ£€æŸ¥å¹¶å®‰è£… Node.js
      - name: è®¾ç½®Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          
      # è®¾ç½® pnpm
      - name: è®¾ç½®pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest
          run_install: true

      # ä¸´æ—¶æ›´æ–°ç‰ˆæœ¬å·ç”¨äºæ„å»º
      - name: ä¸´æ—¶æ›´æ–°ç‰ˆæœ¬å·ç”¨äºæ„å»º
        run: |
          $previewVersion = "${{ steps.version.outputs.version }}"
          
          # ä¸´æ—¶æ›´æ–°package.jsonç‰ˆæœ¬å·ï¼ˆä»…ç”¨äºæ„å»ºï¼Œä¸æäº¤ï¼‰
          $packageJson = Get-Content -Raw -Path "package.json" | ConvertFrom-Json
          $originalVersion = $packageJson.version
          $packageJson.version = $previewVersion
          $packageJson | ConvertTo-Json -Depth 100 | Set-Content -Path "package.json"
          Write-Host "ğŸ¯ ä¸´æ—¶æ›´æ–° package.json ç‰ˆæœ¬å·: $originalVersion -> $previewVersion"
          
          # ä¸´æ—¶æ›´æ–°Cargo.tomlç‰ˆæœ¬å·ï¼ˆä»…ç”¨äºæ„å»ºï¼Œä¸æäº¤ï¼‰
          $cargoToml = Get-Content -Path "src-tauri\Cargo.toml"
          $cargoToml = $cargoToml -replace '^version = ".*"', "version = `"$previewVersion`""
          $cargoToml | Set-Content -Path "src-tauri\Cargo.toml"
          Write-Host "ğŸ¯ ä¸´æ—¶æ›´æ–° Cargo.toml ç‰ˆæœ¬å·ä¸º: $previewVersion"

      # æ„å»º Tauri åº”ç”¨ï¼ˆPreviewç‰ˆæœ¬ï¼‰
      - name: æ„å»ºTauriåº”ç”¨ï¼ˆé¢„è§ˆç‰ˆæœ¬ï¼‰
        run: |
          Write-Host "ğŸš€ Building Preview Version for Windows: ${{ steps.version.outputs.version }}"
          pnpm run build:preview
          pnpm tauri build
          
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆé¢„è§ˆç‰ˆWindowsï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: preview-windows-${{ steps.version.outputs.version }}
          path: src-tauri/target/release/bundle/

  create-release:
    name: åˆ›å»ºå‘å¸ƒ
    needs: [build-windows]
    if: github.event.inputs.create_release == 'true'
    runs-on: [self-hosted, windows, x64] # ä½¿ç”¨ç›¸åŒçš„è‡ªæ‰˜ç®¡ runner
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½Windowsæ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: preview-windows-${{ needs.build-windows.outputs.version }}
          path: ./artifacts/windows

      - name: åˆ›å»ºå‘å¸ƒ
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.build-windows.outputs.tag_name }}
          release_name: "ğŸš€ Preview - ${{ needs.build-windows.outputs.version }}"
          body: |
            # ğŸš€ é¢„è§ˆç‰ˆæœ¬å‘å¸ƒ - ${{ needs.build-windows.outputs.version }}
            
            è¿™æ˜¯ä¸€ä¸ªé¢„è§ˆç‰ˆæœ¬ï¼ŒåŒ…å«æœ€æ–°åŠŸèƒ½å’Œæ”¹è¿›ã€‚
            - **ç‰ˆæœ¬å·**: ${{ needs.build-windows.outputs.version }}
            - **æ„å»ºå¹³å°**: Windows (è‡ªæ‰˜ç®¡)
            - **æ„å»ºç±»å‹**: Preview
            - **å‘å¸ƒæ—¶é—´**: ${{ github.run_id }}
            
            ## ğŸ¯ åŒ…å«çš„æ„å»ºäº§ç‰©
            - Windows å¯æ‰§è¡Œæ–‡ä»¶å’Œå®‰è£…åŒ…
            
            > âš ï¸ é¢„è§ˆç‰ˆæœ¬å¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ï¼Œå»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨ã€‚
          draft: false
          prerelease: true

      - name: ä¸Šä¼ Windowsèµ„æºåˆ°å‘å¸ƒ
        run: |
          $releaseId = "${{ steps.create_release.outputs.id }}"
          $tagName = "${{ needs.build-windows.outputs.tag_name }}"
          
          Write-Host "ğŸ” Searching for Windows build artifacts..."
          $windowsFiles = Get-ChildItem -Path "./artifacts/windows" -Recurse -File
          
          foreach ($file in $windowsFiles) {
            $fileName = $file.Name
            $filePath = $file.FullName
            
            Write-Host "ğŸ“¤ Uploading: $fileName"
            
            # ä½¿ç”¨ GitHub CLI ä¸Šä¼ æ–‡ä»¶ï¼ˆéœ€è¦ç¡®ä¿ gh å·²å®‰è£…ï¼‰
            try {
              gh release upload $tagName $filePath --clobber
              Write-Host "âœ… Successfully uploaded: $fileName"
            } catch {
              Write-Host "âŒ Failed to upload: $fileName - $($_.Exception.Message)"
            }
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
        run: |
          $tagName = "${{ needs.build-windows.outputs.tag_name }}"
          
          Write-Host "ğŸ·ï¸ Creating tag: $tagName"
          
          # é…ç½® git ç”¨æˆ·ï¼ˆä½¿ç”¨ GitHub Actions botï¼‰
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # åˆ›å»ºæ ‡ç­¾
          git tag -a "$tagName" -m "ğŸš€ Preview Release: ${{ needs.build-windows.outputs.version }}"
          
          # æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“
          git push origin "$tagName"
          
          Write-Host "âœ… Tag created and pushed successfully"

      - name: æ¸…ç†æ—§é¢„è§ˆç‰ˆå‘å¸ƒï¼ˆä¿ç•™æœ€æ–°5ä¸ªï¼‰
        run: |
          Write-Host "ğŸ§¹ Cleaning up old preview releases..."
          
          # è·å–æ‰€æœ‰é¢„è§ˆç‰ˆæœ¬çš„releasesï¼ˆæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼‰
          $releases = gh release list --limit 50 --json tagName,createdAt,prerelease,id | ConvertFrom-Json
          $previewReleases = $releases | Where-Object { $_.prerelease -eq $true -and $_.tagName -match "preview" } | Sort-Object createdAt -Descending
          
          Write-Host "Found $($previewReleases.Count) preview releases"
          
          # ä¿ç•™æœ€æ–°çš„5ä¸ªï¼Œåˆ é™¤å…¶ä½™çš„
          if ($previewReleases.Count -gt 5) {
            $releasesToDelete = $previewReleases | Select-Object -Skip 5
            
            foreach ($release in $releasesToDelete) {
              $tagName = $release.tagName
              Write-Host "ğŸ—‘ï¸ Deleting old preview release: $tagName"
              
              try {
                # åˆ é™¤ release
                gh release delete $tagName --yes
                
                # åˆ é™¤å¯¹åº”çš„ tag
                git push --delete origin $tagName
                
                Write-Host "âœ… Deleted: $tagName"
              } catch {
                Write-Host "âŒ Failed to delete: $tagName - $($_.Exception.Message)"
              }
            }
          } else {
            Write-Host "âœ… No cleanup needed (less than 5 preview releases)"
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
